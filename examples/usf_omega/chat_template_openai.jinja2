{#-
Copyright (c) Ultrasafe AI. All rights reserved.
USF Omega Chat Template - OpenAI Compatible
Handles OpenAI-style inputs: tools, response_format at top level

Supports:
- System messages
- Developer messages (with auto-appended instructions for tools/response_format)
- User messages
- Assistant messages (with optional reasoning)
- Tool/Function definitions (OpenAI style: tools=[{type: "function", function: {...}}])
- Tool calls (single and parallel)
- Tool responses with tool_call_id
- Response format schema (structured output)
- Constrained output (json mode)

Parameters:
- tools: list (OpenAI format) - Function definitions
- response_format: dict (OpenAI format) - JSON schema for structured output
- enable_reasoning: bool (default: false) - Enable reasoning/thinking mode
- add_generation_prompt: bool - Add assistant prompt for generation
- json_mode: bool - Enable JSON constrained output
-#}

{%- set start_token = '<|:@:|start|:@:|>' -%}
{%- set end_token = '<|:@::|end|:@::|>' -%}
{%- set reasoning_start = '<|:@:|reasoning_start|:@:|>' -%}
{%- set reasoning_end = '<|:@::|reasoning_end|:@::|>' -%}
{%- set message_start = '<|:@:|message|:@:|>' -%}
{%- set message_end = '<|:@::|message|:@::|>' -%}
{%- set functions_start = '<|:@:|functions_start|:@:|>' -%}
{%- set functions_end = '<|:@::|functions_end|:@::|>' -%}
{%- set invoke_start = '<|:@:|invoke_start|:@:|>' -%}
{%- set invoke_end = '<|:@::|invoke_end|:@::|>' -%}
{%- set constrain_token = '<|:@:|constrain|:@:|>' -%}
{%- set constrain_end = '<|:@::|constrain|:@::|>' -%}
{%- set function_results_token = '<|:@::|function_results|:@::|>' -%}

{%- set enable_reasoning = enable_reasoning | default(false) -%}

{#- Convert OpenAI tools format to simple function list -#}
{%- set has_tools = tools is defined and tools | length > 0 -%}
{%- set has_response_format = response_format is defined -%}

{%- if has_tools -%}
    {%- set function_list = [] -%}
    {%- for tool in tools -%}
        {%- if tool.type == 'function' and tool.function is defined -%}
            {%- set _ = function_list.append(tool.function) -%}
        {%- elif tool.name is defined -%}
            {%- set _ = function_list.append(tool) -%}
        {%- endif -%}
    {%- endfor -%}
{%- endif -%}

{#- Extract schema from OpenAI response_format -#}
{%- if has_response_format -%}
    {%- if response_format.json_schema is defined -%}
        {%- set output_schema = response_format.json_schema.schema | default(response_format.json_schema) -%}
        {%- set schema_strict = response_format.json_schema.strict | default(false) -%}
    {%- elif response_format.schema is defined -%}
        {%- set output_schema = response_format.schema -%}
        {%- set schema_strict = response_format.strict | default(false) -%}
    {%- else -%}
        {%- set output_schema = response_format -%}
        {%- set schema_strict = false -%}
    {%- endif -%}
{%- endif -%}

{#- Auto-generated developer instructions -#}
{%- set function_instructions = "# Functions

## Description

You have access to the functions listed below. These are the **only** functions available to connect with external services.

When the user provides a task, evaluate whether any functions are needed to complete it:

- **Parallel execution:** If some of the tasks are independent, call the relevant functions in parallel for speed optimization.
- **Sequential execution:** If a function's output is required as input for another, execute them sequentially.

You may call functions **multiple times** and in **any order** depending on what the task requires. Optimize for both correctness and speed.

**Important:**
- Always include all **required parameters** as defined in the function schema.
- Do **not** add extra parameters that are not defined in the function schema.

## Function Call Format

To call a function, use the following format:

```
<|:@:|functions_start|:@:|>
<|:@:|invoke_start|:@:|>to=\"function.FUNCTION_NAME\"
<|parameter name=\"PARAM_NAME\"|>PARAM_VALUE<||parameter||>
<|:@::|invoke_end|:@::|>
<|:@::|functions_end|:@::|>
```

For **parallel function calls** (multiple independent calls), include multiple invoke blocks:

```
<|:@:|functions_start|:@:|>
<|:@:|invoke_start|:@:|>to=\"function.FUNCTION_NAME_1\"
<|parameter name=\"param\"|>value1<||parameter||>
<|:@::|invoke_end|:@::|>
<|:@:|invoke_start|:@:|>to=\"function.FUNCTION_NAME_2\"
<|parameter name=\"param\"|>value2<||parameter||>
<|:@::|invoke_end|:@::|>
<|:@::|functions_end|:@::|>
```" -%}

{%- set response_format_instructions = "# Response Format

## Description

Below is the required response format in JSON schema. When generating your response, **always follow this schema**:

- **If `strict: true`:** Do NOT add any keys that are not defined in the schema.
- **If `strict: false`:** You may add extra keys if they are important and relevant to the response.
- **Required keys:** Always include all `required` fields in your responseâ€”even if the value is empty or null, depending on context." -%}

{#- Build tool_call_id to function name mapping for tool responses -#}
{%- set tool_call_map = {} -%}
{%- for message in messages -%}
    {%- if message.tool_calls is defined -%}
        {%- for tc in message.tool_calls -%}
            {%- if tc.id is defined and tc.function is defined -%}
                {%- set _ = tool_call_map.update({tc.id: tc.function.name}) -%}
            {%- endif -%}
        {%- endfor -%}
    {%- endif -%}
{%- endfor -%}

{#- HEADER SECTION: System, Developer, Functions, Response Format -#}

{#- 1. System messages first -#}
{%- for message in messages -%}
    {%- if message.role == 'system' -%}
        {{- start_token }}system
{{ message.content }}{{ end_token }}
{% endif -%}
{%- endfor -%}

{#- 2. Developer messages with auto-appended instructions -#}
{%- set developer_content = [] -%}
{%- for message in messages -%}
    {%- if message.role == 'developer' -%}
        {%- set _ = developer_content.append(message.content) -%}
    {%- endif -%}
{%- endfor -%}

{%- if has_tools -%}
    {%- set _ = developer_content.append(function_instructions) -%}
{%- endif -%}

{%- if has_response_format -%}
    {%- set _ = developer_content.append(response_format_instructions) -%}
{%- endif -%}

{%- if developer_content | length > 0 -%}
    {{- start_token }}developer
{{ developer_content | join('\n\n') }}{{ end_token }}
{% endif -%}

{#- 3. Functions definition -#}
{%- if has_tools -%}
    {{- start_token }}functions
{{ function_list | tojson(indent=2) }}{{ end_token }}
{% endif -%}

{#- 4. Response format schema -#}
{%- if has_response_format -%}
    {{- start_token }}response_format.json
{{ output_schema | tojson(indent=2) }}{{ end_token }}
{% endif -%}

{#- CONVERSATION SECTION: User, Assistant, Tool messages -#}
{%- for message in messages -%}
    {%- if message.role == 'user' -%}
        {{- start_token }}user
{{ message.content }}{{ end_token }}
{% endif -%}

    {%- if message.role == 'assistant' -%}
        {{- start_token }}assistant
{#- Handle constrained output (json mode) -#}
        {%- if message.constrain is defined -%}
            {{- constrain_token }}{{ message.constrain }}
        {%- endif -%}

{#- Handle reasoning/thinking if enabled and present -#}
        {%- if message.reasoning is defined and message.reasoning -%}
            {{- reasoning_start }}
{{ message.reasoning }}
{{ reasoning_end }}
        {%- elif enable_reasoning and message.thinking is defined and message.thinking -%}
            {{- reasoning_start }}
{{ message.thinking }}
{{ reasoning_end }}
        {%- endif -%}

{#- Handle message content -#}
        {%- if message.content -%}
            {{- message_start }}{{ message.content }}{{ message_end }}
        {%- else -%}
            {{- message_start }}{{ message_end }}
        {%- endif -%}

{#- Handle tool calls (single or parallel) -#}
        {%- if message.tool_calls is defined and message.tool_calls -%}
            {{- functions_start }}
            {%- for tool_call in message.tool_calls -%}
                {{- invoke_start }}to="function.{{ tool_call.function.name }}"
                {%- set args = tool_call.function.arguments -%}
                {%- if args is string -%}
                    {%- set args = args | fromjson -%}
                {%- endif -%}
                {%- for key, value in args.items() -%}
                    {%- if value is mapping or value is iterable and value is not string -%}
<|parameter name="{{ key }}"|>{{ value | tojson }}<||parameter||>
                    {%- else -%}
<|parameter name="{{ key }}"|>{{ value }}<||parameter||>
                    {%- endif -%}
                {%- endfor -%}
                {{- invoke_end }}
            {%- endfor -%}
            {{- functions_end }}
        {%- endif -%}

{#- Close constrain if opened -#}
        {%- if message.constrain is defined -%}
            {{- constrain_end }}
        {%- endif -%}
{{ end_token }}
{% endif -%}

    {#- Handle tool responses -#}
    {%- if message.role == 'tool' -%}
        {{- start_token }}tool
{%- if message.tool_call_id is defined -%}
    {%- set func_name = tool_call_map.get(message.tool_call_id, message.name | default('unknown')) -%}
<||function_results_start to=function.{{ func_name }}||>{{ message.content }}<||function_response_end||>
{%- elif message.name is defined -%}
<||function_results_start to=function.{{ message.name }}||>{{ message.content }}<||function_response_end||>
{%- elif message.tool_responses is defined -%}
            {%- for resp in message.tool_responses -%}
<||function_results_start to=function.{{ resp.name }}||>
                {%- if resp.content is mapping -%}
                    {{- resp.content | tojson }}
                {%- else -%}
                    {{- resp.content }}
                {%- endif -%}
<||function_response_end||>
{% endfor -%}
{%- else -%}
{{ message.content }}
{%- endif -%}
{{ function_results_token }}{{ end_token }}
{% endif -%}
{%- endfor -%}

{#- Add generation prompt if requested -#}
{%- if add_generation_prompt -%}
    {{- start_token }}assistant
{%- if json_mode is defined and json_mode -%}
    {{- constrain_token }}json
    {%- if enable_reasoning -%}
        {{- reasoning_start }}
    {%- else -%}
        {{- message_start }}
    {%- endif -%}
{%- elif enable_reasoning -%}
    {{- reasoning_start }}
{%- else -%}
    {{- message_start }}
{%- endif -%}
{%- endif -%}
