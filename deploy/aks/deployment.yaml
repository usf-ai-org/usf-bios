# USF BIOS - Kubernetes Deployment with GPU
apiVersion: apps/v1
kind: Deployment
metadata:
  name: usf-bios
  namespace: usf-bios
  labels:
    app: usf-bios
spec:
  replicas: 1  # Single replica for GPU training
  strategy:
    type: Recreate  # Don't run multiple instances
  selector:
    matchLabels:
      app: usf-bios
  template:
    metadata:
      labels:
        app: usf-bios
    spec:
      # Node selector for GPU nodes
      nodeSelector:
        kubernetes.io/os: linux
        # Uncomment for specific GPU node pool
        # agentpool: gpupool
      
      # Tolerations for GPU nodes
      tolerations:
        - key: "sku"
          operator: "Equal"
          value: "gpu"
          effect: "NoSchedule"
        - key: "nvidia.com/gpu"
          operator: "Exists"
          effect: "NoSchedule"
      
      # Init container to setup directory structure
      initContainers:
        - name: init-storage
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              echo "Creating directory structure..."
              mkdir -p /mnt/usf-storage/data/uploads
              mkdir -p /mnt/usf-storage/data/datasets
              mkdir -p /mnt/usf-storage/data/output
              mkdir -p /mnt/usf-storage/data/checkpoints
              mkdir -p /mnt/usf-storage/data/logs
              mkdir -p /mnt/usf-storage/models
              mkdir -p /mnt/usf-storage/cache/hub
              mkdir -p /mnt/usf-storage/cache/datasets
              chmod -R 777 /mnt/usf-storage
              echo "Storage initialized successfully!"
              ls -la /mnt/usf-storage/
          volumeMounts:
            - name: usf-storage
              mountPath: /mnt/usf-storage
      
      containers:
        - name: usf-bios
          image: arpitsh018/usf-bios:latest
          imagePullPolicy: Always
          
          ports:
            - name: frontend
              containerPort: 3000
              protocol: TCP
          
          # Environment from ConfigMap and Secrets
          envFrom:
            - configMapRef:
                name: usf-bios-config
            - secretRef:
                name: usf-bios-secrets
          
          # Additional environment variables
          env:
            - name: NVIDIA_VISIBLE_DEVICES
              value: "all"
            - name: CUDA_VISIBLE_DEVICES
              value: "0"
            - name: PYTHONUNBUFFERED
              value: "1"
          
          # Resource requests and limits
          resources:
            requests:
              memory: "16Gi"
              cpu: "4"
              nvidia.com/gpu: "1"
            limits:
              memory: "64Gi"
              cpu: "16"
              nvidia.com/gpu: "1"
          
          # Volume mounts
          volumeMounts:
            # Main storage - 1TB PVC
            - name: usf-storage
              mountPath: /mnt/usf-storage
            
            # Symlinks for application paths
            - name: usf-storage
              mountPath: /app/data
              subPath: data
            
            - name: usf-storage
              mountPath: /models
              subPath: models
            
            # Shared memory for PyTorch DataLoader
            - name: dshm
              mountPath: /dev/shm
          
          # Probes
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          
          startupProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30  # 5 minutes total
      
      # Volumes
      volumes:
        # 1TB Persistent Storage
        - name: usf-storage
          persistentVolumeClaim:
            claimName: usf-storage-pvc
        
        # Shared memory for PyTorch
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: 16Gi
      
      # Restart policy
      restartPolicy: Always
      
      # Termination grace period (allow training to save checkpoint)
      terminationGracePeriodSeconds: 300
